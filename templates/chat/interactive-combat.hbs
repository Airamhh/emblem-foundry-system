{{!-- Interactive Combat Result - Step by Step --}}
<div class="fe-combat-result interactive">
  
  {{!-- Combat Header with participants --}}
  <div class="fe-combat-header">
    <div class="fe-participant">
      {{#if attacker.img}}
      <img src="{{attacker.img}}" alt="{{attacker.name}}" class="fe-token-portrait" />
      {{/if}}
      <span class="fe-participant-name">{{attacker.name}}</span>
    </div>
    <div class="fe-vs">VS</div>
    <div class="fe-participant">
      {{#if defender.img}}
      <img src="{{defender.img}}" alt="{{defender.name}}" class="fe-token-portrait" />
      {{/if}}
      <span class="fe-participant-name">{{defender.name}}</span>
    </div>
  </div>

  {{!-- Combat Body with rounds --}}
  <div class="fe-combat-body">
    {{#each rounds}}
    <div class="fe-round {{this.disposition}} {{#if this.isCrit}}fe-critical{{/if}} {{#if this.resolved}}resolved{{else}}pending{{/if}}" data-round-index="{{@index}}">
      
      {{!-- Round Header --}}
      <div class="fe-round-number">
        {{#if (eq this.roundType 'attack')}}
          {{#if (eq @index 0)}}1st Attack{{else}}2nd Attack{{/if}}
        {{else if (eq this.roundType 'counter')}}
          Counter Attack
        {{else if (eq this.roundType 'double')}}
          Follow-up Attack
        {{else if (eq this.roundType 'brave')}}
          Brave Attack
        {{else}}
          Attack
        {{/if}}
      </div>
      
      {{!-- Round Content --}}
      <div class="fe-round-header">
        <div class="fe-round-combatant">
          {{#if this.attackerImg}}
          <img src="{{this.attackerImg}}" alt="{{this.attacker}}" class="fe-round-portrait" title="{{this.attacker}}" />
          {{else}}
          <strong class="fe-attacker-label">{{this.attacker}}</strong>
          {{/if}}
        </div>
        <div class="fe-round-vs">â†’</div>
        <div class="fe-round-combatant">
          {{#if this.defenderImg}}
          <img src="{{this.defenderImg}}" alt="{{this.defender}}" class="fe-round-portrait" title="{{this.defender}}" />
          {{else}}
          <strong class="fe-defender-label">{{this.defender}}</strong>
          {{/if}}
        </div>
      </div>

      {{!-- Round Details --}}
      <div class="fe-round-details">
        <div class="fe-detail-item">
          <span class="fe-detail-label">Weapon</span>
          <span class="fe-detail-value">{{this.weapon}}</span>
        </div>
        <div class="fe-detail-item">
          <span class="fe-detail-label">Hit Chance</span>
          <span class="fe-detail-value">{{this.hitChance}}%</span>
        </div>
      </div>

      {{!-- Interactive Roll Button or Result --}}
      {{#if this.resolved}}
        {{!-- Show result --}}
        <div class="fe-round-result {{#if this.didHit}}hit{{else}}miss{{/if}}">
          <div class="fe-result-roll">
            <i class="fas fa-dice-d20"></i>
            <span class="fe-roll-value">Rolled: {{this.hitRoll}}</span>
          </div>
          {{#if this.didHit}}
            {{#if this.isCrit}}
            <div class="fe-result-status critical">
              <i class="fas fa-burst"></i>
              <strong>CRITICAL HIT!</strong>
              <span class="fe-damage-value">{{this.damage}} damage</span>
            </div>
            {{else}}
            <div class="fe-result-status hit">
              <i class="fas fa-check-circle"></i>
              <strong>HIT!</strong>
              <span class="fe-damage-value">{{this.damage}} damage</span>
            </div>
            {{/if}}
          {{else}}
          <div class="fe-result-status miss">
            <i class="fas fa-times-circle"></i>
            <strong>MISS!</strong>
          </div>
          {{/if}}
          
          {{!-- HP Change --}}
          <div class="fe-hp-change">
            <span class="fe-hp-before">{{this.defenderHPBefore}}</span>
            <i class="fas fa-arrow-right"></i>
            <span class="fe-hp-after">{{this.defenderHPAfter}}</span>
          </div>
        </div>
      {{else}}
        {{!-- Show roll button --}}
        <div class="fe-round-pending">
          <button class="fe-roll-button" data-round-index="{{@index}}" data-message-id="{{../messageId}}">
            <i class="fas fa-dice"></i>
            <span>Roll Attack</span>
          </button>
          <div class="fe-pending-indicator">
            <i class="fas fa-hourglass-half"></i>
            <span>Awaiting roll...</span>
          </div>
        </div>
      {{/if}}
    </div>
    {{/each}}
  </div>

  {{!-- Combat Footer - Summary (only show when all resolved) --}}
  {{#if allResolved}}
  <div class="fe-combat-footer">
    <div class="fe-summary-grid">
      <!-- Atacante -->
      <div class="fe-summary-combatant {{attacker.disposition}}">
        <div class="fe-combatant-label">Attacker</div>
        {{#if attacker.img}}
        <img src="{{attacker.img}}" alt="{{attacker.name}}" class="fe-summary-portrait" />
        {{/if}}
        <div class="fe-summary-name">{{attacker.name}}</div>
        <div class="fe-summary-stat">
          <span class="fe-stat-label">HP</span>
          <span class="fe-stat-value">
            <span class="fe-hp-start">{{attacker.hpStart}}</span>
            <i class="fas fa-arrow-right"></i>
            <span class="fe-hp-end">{{attacker.hpEnd}}</span>
            {{#if attacker.hpChange}}
            <span class="fe-hp-diff">({{attacker.hpChange}})</span>
            {{/if}}
          </span>
        </div>
        {{#if attacker.weapon}}
        <div class="fe-summary-stat">
          <span class="fe-stat-label">Weapon</span>
          <span class="fe-stat-value">
            {{attacker.weapon}}
            {{#if attacker.weaponUsesAfter}}
            <span class="fe-uses">({{attacker.weaponUsesAfter}}/{{attacker.weaponMaxUses}})</span>
            {{#if attacker.weaponUsesUsed}}
            <span class="fe-uses-spent">(-{{attacker.weaponUsesUsed}})</span>
            {{/if}}
            {{/if}}
          </span>
        </div>
        {{/if}}
      </div>

      <!-- Defensor -->
      <div class="fe-summary-combatant {{defender.disposition}}">
        <div class="fe-combatant-label">Defender</div>
        {{#if defender.img}}
        <img src="{{defender.img}}" alt="{{defender.name}}" class="fe-summary-portrait" />
        {{/if}}
        <div class="fe-summary-name">{{defender.name}}</div>
        <div class="fe-summary-stat">
          <span class="fe-stat-label">HP</span>
          <span class="fe-stat-value">
            <span class="fe-hp-start">{{defender.hpStart}}</span>
            <i class="fas fa-arrow-right"></i>
            <span class="fe-hp-end">{{defender.hpEnd}}</span>
            {{#if defender.hpChange}}
            <span class="fe-hp-diff">({{defender.hpChange}})</span>
            {{/if}}
          </span>
        </div>
        {{#if defender.weapon}}
        <div class="fe-summary-stat">
          <span class="fe-stat-label">Weapon</span>
          <span class="fe-stat-value">
            {{defender.weapon}}
            {{#if defender.weaponUsesAfter}}
            <span class="fe-uses">({{defender.weaponUsesAfter}}/{{defender.weaponMaxUses}})</span>
            {{#if defender.weaponUsesUsed}}
            <span class="fe-uses-spent">(-{{defender.weaponUsesUsed}})</span>
            {{/if}}
            {{/if}}
          </span>
        </div>
        {{/if}}
      </div>
    </div>
  </div>
  {{/if}}

</div>
